<!-- templates/cart.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Your Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  {% include 'shared/navBar.jinja' %}
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4 pt-5">Your Cart</h1>

  {% if items|length == 0 %}
    <div class="alert alert-info">Your cart is empty. <a class="btn btn-primary" href="{{ url_for('browse') }}">Browse products</a></div>
  {% else %}
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Product</th>
          <th width="140">Price</th>
          <th width="140">Qty</th>
          <th width="140">Total</th>
          <th>Where</th>
          <th width="60"></th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>
            <div class="d-flex align-items-center gap-3">
              <img src="{{ it.img }}" alt="{{ it.title }}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;">
              <div>
                <div class="fw-semibold">{{ it.title }}</div>
                <a class="small text-muted" href="{{ it.link }}" target="_blank" rel="noopener">View on site</a>
              </div>
            </div>
          </td>
          <td>${{ '%.2f'|format(it.price) }}</td>
          <td>
            <div class="input-group">
              <button class="btn btn-outline-secondary btn-qty" data-id="{{ it.id }}" data-delta="-1">-</button>
              <input class="form-control text-center qty-input" style="max-width:70px" value="{{ it.qty }}" data-id="{{ it.id }}">
              <button class="btn btn-outline-secondary btn-qty" data-id="{{ it.id }}" data-delta="1">+</button>
            </div>
          </td>
          <td>${{ '%.2f'|format(it.line_total) }}</td>
          <td>
            <a href="{{ it.link }}"class="badge bg-white">
                <img src="{{ it.brand_logo }}" width="30px"/>
            </a>
          </td>
          <td><button class="btn btn-link text-danger p-0 btn-remove" data-id="{{ it.id }}">âœ•</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end align-items-center gap-3">
    <div class="fs-5">Subtotal: <strong>${{ '%.2f'|format(subtotal) }}</strong></div>
    <a class="btn btn-outline-secondary" href="{{ url_for('browse') }}">Continue shopping</a>
    <button class="btn btn-danger" id="clear-cart">Clear cart</button>
  </div>
  {% endif %}
</div>

<script>
async function postUpdate(pid, qty) {
  const res = await fetch("{{ url_for('cart_update') }}", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ product_id: Number(pid), qty: Number(qty) })
  });
  return res.json();
}

document.querySelectorAll(".btn-qty").forEach(b => {
  b.addEventListener("click", async () => {
    const id = b.dataset.id;
    const delta = Number(b.dataset.delta);
    const input = document.querySelector(`.qty-input[data-id="${id}"]`);
    const next = Math.max(0, Number(input.value || 0) + delta);
    const data = await postUpdate(id, next);
    if (data.ok) location.reload();
  });
});

document.querySelectorAll(".qty-input").forEach(inp => {
  inp.addEventListener("change", async () => {
    const id = inp.dataset.id;
    const next = Math.max(0, Number(inp.value || 0));
    const data = await postUpdate(id, next);
    if (data.ok) location.reload();
  });
});

document.querySelectorAll(".btn-remove").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    const data = await postUpdate(id, 0);
    if (data.ok) location.reload();
  });
});

document.getElementById("clear-cart")?.addEventListener("click", async () => {
  const res = await fetch("{{ url_for('cart_clear') }}", { method: "POST" });
  const data = await res.json();
  if (data.ok) location.reload();
});
</script>
</body>
</html>
